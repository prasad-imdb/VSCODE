SELECT 
    WAREHOUSE_NAME, 
    DATE(START_TIME) AS DATE, 
    SUM(CREDITS_USED) AS CREDITS_USED,
    AVG(SUM(CREDITS_USED)) OVER (PARTITION BY WAREHOUSE_NAME ORDER BY DATE ROWS 7 PRECEDING) AS CREDITS_USED_7_DAY_AVERAGE, 
    (TO_NUMERIC(SUM(CREDITS_USED)/CREDITS_USED_7_DAY_AVERAGE*100,10,2)-100)::STRING || '%' AS VARIANCE_TO_7_DAY_AVERAGE
FROM "SNOWFLAKE"."ACCOUNT_USAGE"."WAREHOUSE_METERING_HISTORY"
GROUP BY DATE, WAREHOUSE_NAME
ORDER BY DATE DESC;