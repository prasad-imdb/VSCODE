CREATE OR REPLACE TASK EMAIL_OPEN_TASK
  WAREHOUSE = COMPUTE_WH
  SCHEDULE = '60 MINUTE'
AS
 CALL AZACCP.SDW_ACC_DB.SALESFORCE_SYNCOUT_SNFL_INGESTION_WORKFLOW('CLM','1');
 
ALTER TASK EMAIL_OPEN_TASK RESUME;

CREATE or replace TASK EMAIL_OPEN_TASK_ALERT
  WAREHOUSE = COMPUTE_WH
  AFTER EMAIL_OPEN_TASK
AS

EXECUTE IMMEDIATE
$$
DECLARE C_MSG VARCHAR(255); 
BEGIN 
select MSG INTO C_MSG 
from AZACCP.SDW_ACC_DB.SLSFRC_SYNC_USECASE_MGT_LOG_T
where FILE = 'SLSFRC_SYNC_EML_OPENS' AND run_id = 1 and
UTC_TS = (select max(UTC_TS) FROM AZACCP.SDW_ACC_DB.SLSFRC_SYNC_USECASE_MGT_LOG_T
where FILE = 'SLSFRC_SYNC_EML_OPENS' AND run_id = 1 );

IF C_MSG = 'success' 
THEN 
CALL SYSTEM$SEND_EMAIL(
    'EMAIL_NOTIFICATION_INTEGRATION',
    'sravanjsfwh@gmail.com',
    'Email Alert: Task has finished.',
    'Load completed successfully');
ELSE 
CALL SYSTEM$SEND_EMAIL(
    'EMAIL_NOTIFICATION_INTEGRATION',
    'sravanjsfwh@gmail.com',
    'Email Alert: Task Failed.',
    'Load Failed');  
END IF; 
END;
$$;

